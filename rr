
import re
import json
import ast
from pathlib import Path

import pandas as pd


INPUT_DIR = Path("foldername/llm_raw")   
OUTPUT_XLSX = "final_sheet.xlsx"

FILENAME_COL = "FileName"              
EXTRACTED_CLAUSES_KEY = "extracted_clauses"

DELIM = ".\n\n"                         
INCLUDE_CLAUSE_TYPE = False             
# ----------------------------


def extract_json_block(text: str) -> str | None:
    
    m = re.search(r"```json\s*(\{.*?\})\s*```", text, flags=re.DOTALL | re.IGNORECASE)
    if m:
        return m.group(1).strip()
    return None


def safe_load_json(s: str):
    
    try:
        return json.loads(s)
    except Exception:
        return ast.literal_eval(s)


def clean_clause_text(t: str) -> str:
    if t is None:
        return ""
    if not isinstance(t, str):
        t = str(t)

    idx = t.find(DELIM)
    if idx == -1:
        return t.strip()
    return t[idx + len(DELIM):].lstrip()


def rag_col_name(i: int) -> str:
    
    return "extracted_clauses_RAG" if i == 0 else f"extracted_clauses{i+1}_RAG"


def as_cell_value(v):
    
    if v is None:
        return ""
    if isinstance(v, (dict, list)):
        return json.dumps(v, ensure_ascii=False)
    return v


def build_clause_cell(clause: dict) -> str:
    ctype = (clause.get("clause_type") or "").strip()
    ctext_raw = clause.get("clause_text")
    csection = (clause.get("clause_section") or "").strip()

    ctext = clean_clause_text(ctext_raw)

    parts = []
    if INCLUDE_CLAUSE_TYPE and ctype:
        parts.append(ctype)             
    if ctext:
        parts.append(ctext)             
    if csection:
        parts.append(csection)         

    return "\n\n".join(parts).strip()


def process_folder(input_dir: Path) -> pd.DataFrame:
    rows = []
    all_rag_cols = set()
    has_client = False

    for p in sorted(input_dir.glob("*.txt")):
        raw = p.read_text(encoding="utf-8", errors="ignore")
        js = extract_json_block(raw)
        if not js:
            # If no fenced block, skip (or you can raise)
            print(f"⚠️ Skipping (no ```json block found): {p.name}")
            continue

        try:
            data = safe_load_json(js)
        except Exception as e:
            print(f"❌ Failed to parse JSON in {p.name}: {e}")
            continue

        if not isinstance(data, dict):
            print(f"⚠️ Skipping (JSON is not an object/dict): {p.name}")
            continue

        row = {}

        
        if "client" in data:
            row["client"] = data.get("client")
            has_client = True
        elif "Client" in data:
            row["client"] = data.get("Client")
            has_client = True

        # FileName as requested
        row[FILENAME_COL] = p.stem

        
        for k, v in data.items():
            if k in ("client", "Client"):
                continue
            if k == EXTRACTED_CLAUSES_KEY:
                continue
            row[k] = as_cell_value(v)

        
        clauses = data.get(EXTRACTED_CLAUSES_KEY, [])
        if isinstance(clauses, dict):
         
            keys = list(clauses.keys())
            if all(isinstance(x, str) and x.isdigit() for x in keys):
                clauses = [clauses[k] for k in sorted(keys, key=lambda x: int(x))]
            else:
                clauses = list(clauses.values())

        if not isinstance(clauses, list):
            clauses = []

        for i, clause in enumerate(clauses):
            col = rag_col_name(i)
            all_rag_cols.add(col)
            if isinstance(clause, dict):
                row[col] = build_clause_cell(clause)
            else:
                row[col] = as_cell_value(clause)

        rows.append(row)

    df = pd.DataFrame(rows)


    def rag_index(name: str) -> int:
       
        tail = name.replace("extracted_clauses", "").replace("_RAG", "")
        return 1 if tail == "" else int(tail)

    rag_cols_sorted = sorted([c for c in df.columns if c.startswith("extracted_clauses") and c.endswith("_RAG")],
                             key=rag_index)

    for c in rag_cols_sorted:
        if c not in df.columns:
            df[c] = ""

    # 
    cols = list(df.columns)
    ordered = []

    if has_client and "client" in cols:
        ordered.append("client")            
    else:
        
        df.insert(0, "record_id", range(1, len(df) + 1))
        cols = list(df.columns)
        ordered.append("record_id")           # 1st column

    if FILENAME_COL in cols:
        ordered.append(FILENAME_COL)          # 2nd column

    # Put RAG cols next
    ordered.extend([c for c in rag_cols_sorted if c in cols])

    # Remaining columns
    for c in cols:
        if c not in ordered:
            ordered.append(c)

    df = df[ordered]
    return df


def main():
    df = process_folder(INPUT_DIR)
    df.to_excel(OUTPUT_XLSX, index=False)
    print(f"Saved Excel: {OUTPUT_XLSX}")


if __name__ == "__main__":
    main()
